<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />

    <title>Darlene Rabis | Home</title>

    <script src="scramble.js"></script>

	<meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="icon" href="images/luffy-smile-rb.png" />
    <link rel="shortcut icon" href="images/luffy-smile-rb.png" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/hack-font/3.3.0/web/hack.min.css"
      integrity="sha512-XgCw4Srl8lC1ECwcaHwAU0WnxQwHkqmInzg9wJLtGB7DRuMaXPuK2k9WJ2AwRDGdrgK9eJpZl2hUlLi2WQssmw=="
      crossorigin="anonymous"
    />
</head>
<body>
    <header>Darlene Rabis</header>

    <button id="toggleSidebar" class="toggle-btn closed">☰</button>

    <div id="sidebar" class="closed">
        <h3>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Controles</h3>
        <button id="resetView">Resetar Visão</button>
        <button id="wireframe">Wireframe</button>
        <hr>
        <h3>Sensores</h3>
        <div id="sensorList"></div>
    </div>

    <div id="mainContent">
        <div id="main-canvas">
            <div id="hotspots"></div>
        </div>

        <div class="chart-container" id="chartContainer">
            <h4 id="chartTitle">Histórico do Sensor</h4>
            <canvas id="sensorChart"></canvas>
        </div>
    </div>

    <footer>© 2025 Projeto Kombi — Monitoramento em tempo real</footer>


    <!-- Import map + módulos ES -->
    <script type="importmap">
    {
        "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- CONFIG ---
        const MODEL_URL = './assets/darlene.glb'; // coloque seu .glb aqui
        const SENSOR_MAP = [
        {id:'engine_temp', nodeName:'engine_node', label:'Temperatura Motor'},
        {id:'door_left', nodeName:'left_door', label:'Porta Esquerda'},
        {id:'battery', nodeName:'battery_node', label:'Bateria'}
        ];


        // --- SCENE SETUP ---
        const container = document.getElementById('main-canvas');
        const scene = new THREE.Scene();
        const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.setSize(container.clientWidth, container.clientHeight);
        // renderer.outputEncoding = THREE.sRGBEncoding;
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        container.appendChild(renderer.domElement);

        window.addEventListener('resize', () => {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
        });


        const camera = new THREE.PerspectiveCamera(45, container.clientWidth/container.clientHeight, 0.1, 1000);
        camera.position.set(400,300,500);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.7);
        scene.add(hemi);
        const dir = new THREE.DirectionalLight(0xffffff, 0.8);
        dir.position.set(5,10,7);
        scene.add(dir);

        const grid = new THREE.GridHelper(6,12,'#1f2937','#111827');
        grid.material.opacity = 0.12; grid.material.transparent = true;
        scene.add(grid);

        // --- LOAD MODEL ---
        const loader = new GLTFLoader();
        let kombi = null;
        loader.load(MODEL_URL, gltf => {
        kombi = gltf.scene;
        kombi.name = 'kombi';
        kombi.traverse(child => { if(child.isMesh){ child.castShadow = true; child.receiveShadow = true; } });
        scene.add(kombi);

        SENSOR_MAP.forEach(s => {
            const node = kombi.getObjectByName(s.nodeName);
            const pos = node ? node.getWorldPosition(new THREE.Vector3()) : new THREE.Vector3(0,1,0);
            createHotspot(s.id, s.label, pos);
        });

        populateSensorsList();
        }, xhr => {
        // progresso opcional
        }, err => {
        console.warn('Falha ao carregar modelo. Verifique MODEL_URL e caminho do arquivo .glb.');
        });

        // --- RESIZE ---
        window.addEventListener('resize', () => {
        renderer.setSize(container.clientWidth, container.clientHeight);
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        });

        // --- HOTSPOTS ---
        const hotspotsRoot = document.getElementById('hotspots');
        const hotspots = {};

        function createHotspot(id, label, worldPos){
        const el = document.createElement('div'); el.className='hotspot';
        el.dataset.id = id;
        el.innerHTML = `<div class='dot' title='${label}'></div><div class='tooltip' style='display:none'>${label}: <span class='value'>--</span></div>`;
        hotspotsRoot.appendChild(el);
        hotspots[id] = {el, worldPos: worldPos.clone(), label};

        

        // --- Evento de clique no hotspot ---
        el.querySelector('.dot').addEventListener('click', () => {
        showSensorChart(label, id);
        });

        // show tooltip on hover
        el.addEventListener('mouseenter', () => { el.querySelector('.tooltip').style.display = 'block'; });
        el.addEventListener('mouseleave', () => { el.querySelector('.tooltip').style.display = 'none'; });
        }

        function updateHotspotsScreenPositions(){
        Object.values(hotspots).forEach(h => {
            const pos = h.worldPos.clone();
            pos.project(camera);
            const x = (pos.x * 0.5 + 0.5) * container.clientWidth;
            const y = ( - pos.y * 0.5 + 0.5) * container.clientHeight;
            h.el.style.left = x + 'px';
            h.el.style.top = y + 'px';
        });
        }

        // --- MOCK DATA (substituir por WS/MQTT) ---
        function mockSensorUpdates(){
        setInterval(() => {
            SENSOR_MAP.forEach(s => {
            const v = (Math.random()*100).toFixed(1);
            setSensorValue(s.id, v);
            });
        }, 1200);
        }

        function setSensorValue(id, value){
        const row = document.querySelector(`#sensorsList [data-id='${id}']`);
        if(row) row.querySelector('.val').textContent = value;
        const h = hotspots[id];
        if(h){
            h.el.querySelector('.tooltip .value').textContent = value;
            const num = parseFloat(value);
            const color = num>70 ? '#ef4444' : (num>40? '#f59e0b' : '#10b981');
            const dot = h.el.querySelector('.dot');
            dot.style.background = color;
            dot.style.boxShadow = `0 0 8px ${color}66`;
        }
        }

        function populateSensorsList(){
        const c = document.getElementById('sensorsList'); c.innerHTML = '';
        SENSOR_MAP.forEach(s => {
            const r = document.createElement('div'); r.style.padding='6px 0'; r.dataset.id = s.id;
            r.innerHTML = `<strong>${s.label}</strong> <div style='float:right' class='val'>--</div>`;
            c.appendChild(r);
        });
        }

        // --- BUTTONS ---
        document.getElementById('resetView').addEventListener('click', () => {
        controls.reset();
        camera.position.set(400,300,500);
        });
        let wf = false;
        document.getElementById('wireframe').addEventListener('click', () => {
        wf = !wf; if(kombi) kombi.traverse(c => { if(c.isMesh) c.material.wireframe = wf; });
        });

        // --- RENDER LOOP ---
        function animate(){
        requestAnimationFrame(animate);
        controls.update();
        if(kombi) updateHotspotsScreenPositions();
        renderer.render(scene, camera);
        }
        animate();
        mockSensorUpdates();

        // --- Exibe o gráfico flutuante ---
        function showSensorChart(label, id) {
        const chartBox = document.getElementById('chartContainer');
        const title = document.getElementById('chartTitle');
        const canvas = document.getElementById('sensorChart');

        title.textContent = `Histórico: ${label}`;
        chartBox.style.display = 'block';

        // Destroi gráfico antigo se já existir
        if (window.activeChart) {
            window.activeChart.destroy();
        }

        // Cria um novo gráfico simulado
        const ctx = canvas.getContext('2d');
        const data = Array.from({ length: 20 }, () => Math.random() * 100);

        window.activeChart = new Chart(ctx, {
            type: 'line',
            data: {
            labels: data.map((_, i) => i),
            datasets: [{
                label: label,
                data: data,
                borderColor: '#7fd13b',
                tension: 0.3,
                fill: false
            }]
            },
            options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, grid: { color: '#444' } } }
            }
        });
        }

        // --- TOGGLE SIDEBAR ---
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggleSidebar');

        toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('closed');
        toggleBtn.classList.toggle('closed');
        toggleBtn.textContent = sidebar.classList.contains('closed') ? '☰' : '✖';
        });


        // --- NOTES: para usar dados reais ---
        // - Substitua mockSensorUpdates por conexão WebSocket/MQTT e chame setSensorValue(id, value)
        // - Para hotspot preciso: no Blender renomeie objetos e exporte .glb com os nomes (ex: engine_node)
    </script>
  <footer>© 2025 Projeto Kombi — Monitoramento em tempo real</footer>
</body>
</html>
